<!DOCTYPE html>
<head>
	<title>Shatter</title>

	<link rel="stylesheet" href="../CSS/theme-index.css" />
	<link rel="stylesheet" href="../CSS/index.css" />
	<link rel="icon" type="image/x-icon" href="../UI/favicon.ico" />

	<!-- main js stuff, copy paste -->
	<script src="../JS/supabase.js"></script>
	<script src="../JS/accounts.js"></script>
	<script src="../JS/fetch.js"></script>
	<script src="../JS/main.js" type="module"></script>

	<style>
		#display,
		ruffle-player {
			width: 100%;
			height: 99vh;
		}

		html,
		body {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
		}

		.background {
			background: var(--color-major);
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: -5;
		}
		.overlay {
		position: fixed;
		top: 0;
		left: 0;
		width: 100vw;
		height: 99vh;
		background-color: rgba(0, 0, 0, 0.5);
		z-index: 9999;
		pointer-events: all;
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		visibility: hidden;
	}
	</style>
</head>

<body>
	<div class="background"></div>
	<div class="overlay">
		<img src="../UI/loading.svg" style="width: 50%; height: 50%" />
		<h1 style="font-size: xxx-large; color: var(--color-text-light)">Please wait...</h1>
	</div>
	<script src="../ruffle/ruffle.js"></script>
	<script type="module">
		document.getElementsByClassName("overlay")[0].style.visibility = "visible";
		const params = new URLSearchParams(window.location.search);
		const src = params.get("id");
		let breake;
		let srcFetch;
	
		if (src != null || src == "") {
			if (params.has("flash", true)) {
				try {
					srcFetch = await fetch("https://ssh-lvl.github.io/shatter-games/game-sources/-flash/" + encodeURIComponent(src));
					if (!srcFetch.ok) {
						throw new Error('Failed to fetch the game');
					}
				} catch (error) {
					await displayNotFound();
					breake = true;
				}
				if (!breake) {
					const flashContainer = document.createElement("div");
					flashContainer.id = "flash-container";
					flashContainer.style.width = "100%";
					flashContainer.style.height = "100%";
					flashContainer.style.display = "flex";
					flashContainer.style.justifyContent = "center";
					flashContainer.style.alignItems = "center";
					flashContainer.style.overflow = "hidden";
	
					const rufflePlayerContainer = document.createElement("div");
					rufflePlayerContainer.id = "ruffle-player";
					rufflePlayerContainer.style.width = "100%";
					rufflePlayerContainer.style.height = "100%";
	
					flashContainer.appendChild(rufflePlayerContainer);
	
					document.body.appendChild(flashContainer);
	
					const ruffle = window.RufflePlayer.newest();
					const player = ruffle.createPlayer();
					rufflePlayerContainer.appendChild(player);
	
					const blob = await srcFetch.blob();
					const objectUrl = URL.createObjectURL(blob);
					player.load(objectUrl);
					document.getElementsByClassName("overlay")[0].style.visibility = "hidden";
				}
			} else {
				// Fetch to check if the resource exists
				const iframeUrl = "https://ssh-lvl.github.io/shatter-games/game-sources/" + src;
				try {
					const iframeFetch = await fetch(iframeUrl, { method: 'HEAD' });
					if (!iframeFetch.ok) {
						throw new Error('Failed to load the game');
					}
					const display = document.createElement("iframe");
					display.id = "display";
					display.frameBorder = 0;
					document.body.appendChild(display);
					display.src = iframeUrl;
				} catch (error) {
					await displayNotFound();
				}
				document.getElementsByClassName("overlay")[0].style.visibility = "hidden";
			}
		} else {
			await displayNotFound();
		}
	
		function displayNotFound() {
			document.getElementsByClassName("overlay")[0].style.visibility = "hidden";
			const errortext = document.createElement("h1");
			errortext.id = "error-text";
			errortext.style.color = "var(--color-text-light)";
			errortext.style.textAlign = "center";
			errortext.innerHTML = "Oops! <br>We couldn't find this game...<br>If you think this is an error please report it ";
			const linktext = document.createElement("a");
			linktext.textContent = "here!";
			linktext.style.color = "var(--color-button)";
			linktext.onmouseover = () => {
				linktext.style.color = "var(--color-button-hover)";
			};
			linktext.onmouseout = () => {
				linktext.style.color = "var(--color-button)";
			};
			linktext.href = "support.html";
	
			errortext.appendChild(linktext);
			document.body.appendChild(errortext);
		}
	</script>
	
	
</body>
